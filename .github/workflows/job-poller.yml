name: Wait for Amplify Build Status

on:
  workflow_call:

jobs:
  wait-for-amplify-build:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials from OIDC
        uses: aws-actions/configure-aws-credentials@v4.2.1
        with:
          role-session-name: personal-website-gha
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Wait for Amplify build to complete
        id: amplify
        run: |
          APP_ID="${{ secrets.AMPLIFY_APP_ID }}"
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          MAX_RETRIES=20
          DELAY=60  # 1 minute delay
          COUNT=0

          echo "Polling Amplify build status for branch: $BRANCH_NAME"
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
            JOB=$(aws amplify list-jobs \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --max-items 1 \
              --query 'jobSummaries[0]' \
              --output json)

            JOB_STATUS=$(echo "$JOB" | jq -r '.status')
            JOB_ID=$(echo "$JOB" | jq -r '.jobId')

            echo "Attempt $((COUNT + 1)): Status = $JOB_STATUS"

            if [[ "$JOB_STATUS" == "SUCCEED" || "$JOB_STATUS" == "FAILED" || "$JOB_STATUS" == "CANCELLED" ]]; then
              echo "Build completed with status: $JOB_STATUS"
              break
            fi

            COUNT=$((COUNT + 1))
            sleep $DELAY
          done

          if [[ "$JOB_STATUS" == "FAILED" || "$JOB_STATUS" == "CANCELLED" ]]; then
            echo "Build ended in a failed state."
            exit 1
          elif [[ "$JOB_STATUS" != "SUCCEED" ]]; then
            echo "Build did not complete in time."
            exit 1
          fi

          echo "status=$JOB_STATUS" >> "$GITHUB_OUTPUT"
          echo "job_id=$JOB_ID" >> "$GITHUB_OUTPUT"